<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AR Museum Experience</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    body { 
      margin: 0; 
      overflow: hidden; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: #000; 
      color: #d1fae5;
      touch-action: none;
    }
    
    .icon-btn { 
      width: 55px; 
      height: 55px; 
      background: rgba(214,229,220,0.25); 
      border: 2px solid rgba(0,255,102,0.7); 
      border-radius: 50%; 
      color: #ffffff; 
      font-size: 1.3rem; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      touch-action: manipulation;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.2s ease;
    }
    
    .icon-btn:active {
      transform: scale(0.95);
      background: rgba(0,255,102,0.4);
    }
    
    .icon-btn.recording {
      background: rgba(255,0,0,0.7);
      border-color: rgba(255,0,0,0.9);
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .top-left-group { 
      position: fixed; 
      top: 20px; 
      left: 15px; 
      z-index: 100; 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
    }
    
    .bottom-center-group { 
      position: fixed; 
      bottom: 25px; 
      left: 50%; 
      transform: translateX(-50%); 
      display: flex; 
      gap: 15px; 
      z-index: 100; 
    }
    
    .top-right { 
      position: fixed; 
      top: 20px; 
      right: 15px; 
      z-index: 100; 
      background: rgba(0,255,102,0.2); 
      color: #000; 
      border: 2px solid rgba(0,255,102,0.5); 
      padding: 10px 15px; 
      border-radius: 12px; 
      font-size: 14px;
      font-weight: 600;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .loading { 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%,-50%); 
      background: rgba(0,0,0,0.95); 
      color: white; 
      padding: 30px; 
      border-radius: 20px; 
      z-index: 1000; 
      text-align: center; 
      width: 85%;
      max-width: 300px;
      border: 2px solid #00ff66;
    }
    
    .loading h3 {
      font-size: 1.4em;
      margin-bottom: 15px;
      color: #00ff66;
    }
    
    .loading p {
      font-size: 1.1em;
      margin-bottom: 10px;
    }
    
    .info-panel { 
      display: none; 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%,-50%); 
      background: rgba(0,40,0,0.98); 
      border: 3px solid #00ff66; 
      border-radius: 20px; 
      padding: 25px; 
      z-index: 1000; 
      width: 90%; 
      max-width: 400px; 
      max-height: 70vh; 
      overflow-y: auto; 
      color: white;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    
    .info-panel h3 { 
      color: #00ff66; 
      font-size: 1.5em; 
      margin-bottom: 15px; 
      text-align: center; 
      font-weight: 700;
    }
    
    .info-panel p { 
      font-size: 1.1em; 
      line-height: 1.6; 
      text-align: justify;
      margin-bottom: 20px;
    }
    
    .close-btn {
      margin-top: 15px;
      padding: 12px 20px;
      background: #00ff66;
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 700;
      width: 100%;
      transition: all 0.3s ease;
    }
    
    .close-btn:active {
      transform: scale(0.95);
      background: #00cc55;
    }

    .error-message {
      background: rgba(255,0,0,0.9);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
      text-align: center;
    }

    .camera-permission-btn {
      background: #00ff66;
      color: #000;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: 700;
      margin-top: 15px;
      cursor: pointer;
      width: 100%;
    }

    .feedback-btn {
      position: fixed;
      bottom: 120px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: rgba(214,229,220,0.25);
      border: 2px solid rgba(0,255,102,0.7);
      border-radius: 50%;
      color: #ffffff;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 100;
      cursor: pointer;
    }

    /* Recording indicator */
    .recording-indicator {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,0,0,0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 8px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      animation: pulse 1.5s infinite;
    }

    .recording-indicator .dot {
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    /* Hidden video for recording */
    #cameraVideo {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -1;
      opacity: 0;
    }

    /* FEEDBACK POPUP STYLES */
    .feedback-popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 9999;
      padding: 20px;
      backdrop-filter: blur(5px);
    }

    .feedback-popup.active {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .feedback-form {
      background: #fff;
      padding: 30px;
      border-radius: 15px;
      width: 100%;
      max-width: 450px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }

    .feedback-header {
      text-align: center;
      margin-bottom: 25px;
    }

    .feedback-header h2 {
      color: #0a3d2f;
      font-size: 1.8rem;
      margin-bottom: 10px;
    }

    .feedback-header p {
      color: #666;
      font-size: 0.95rem;
    }

    .form-group {
      position: relative;
      margin-bottom: 20px;
    }

    .form-group i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #0a3d2f;
      font-size: 1.1rem;
      z-index: 2;
    }

    .form-group.textarea i {
      top: 25px;
      transform: none;
    }

    .form-group select {
      width: 100%;
      padding: 12px 15px 12px 45px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #f9f9f9;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    .form-group select:focus {
      outline: none;
      border-color: #0a3d2f;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(10, 61, 47, 0.1);
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px 12px 45px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #f9f9f9;
    }

    .form-group textarea {
      padding-top: 15px;
      min-height: 120px;
      resize: vertical;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #0a3d2f;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(10, 61, 47, 0.1);
    }

    .submit-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #0a3d2f, #1b725a);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .submit-btn:hover {
      background: linear-gradient(135deg, #1b725a, #0a3d2f);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .close-feedback {
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #666;
      cursor: pointer;
      transition: color 0.3s ease;
      z-index: 3;
    }

    .close-feedback:hover {
      color: #ff4444;
    }

    .success-message {
      display: none;
      text-align: center;
      padding: 30px 20px;
      background: #d4edda;
      color: #155724;
      border-radius: 8px;
      margin-top: 15px;
      border: 1px solid #c3e6cb;
    }

    .success-message i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: #28a745;
    }

    .success-message h3 {
      margin-bottom: 10px;
      color: #155724;
    }

    /* Star rating colors */
    .form-group select option[value="5"] { color: #28a745; font-weight: bold; }
    .form-group select option[value="4"] { color: #20c997; font-weight: bold; }
    .form-group select option[value="3"] { color: #ffc107; font-weight: bold; }
    .form-group select option[value="2"] { color: #fd7e14; font-weight: bold; }
    .form-group select option[value="1"] { color: #dc3545; font-weight: bold; }
    
    /* Mobile-specific optimizations */
    @media (max-width: 768px) {
      .icon-btn {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
      }
      
      .top-left-group {
        top: 15px;
        left: 10px;
        gap: 10px;
      }
      
      .bottom-center-group {
        bottom: 20px;
        gap: 12px;
      }
      
      .top-right {
        top: 15px;
        right: 10px;
        font-size: 13px;
        padding: 8px 12px;
      }
      
      .info-panel {
        padding: 20px;
        width: 95%;
      }
      
      .info-panel h3 {
        font-size: 1.3em;
      }
      
      .info-panel p {
        font-size: 1em;
      }

      .feedback-btn {
        bottom: 80px;
        right: 15px;
        width: 55px;
        height: 55px;
        font-size: 1.3rem;
      }

      .feedback-form {
        padding: 25px 20px;
        margin: 15px;
      }

      .feedback-header h2 {
        font-size: 1.5rem;
      }

      .recording-indicator {
        top: 15px;
        font-size: 12px;
        padding: 6px 12px;
      }
    }
    
    @media (max-width: 480px) {
      .icon-btn {
        width: 45px;
        height: 45px;
        font-size: 1.1rem;
      }
      
      .loading {
        padding: 25px;
        width: 90%;
      }
      
      .loading h3 {
        font-size: 1.2em;
      }

      .feedback-btn {
        bottom: 70px;
        right: 10px;
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
      }

      .feedback-popup {
        padding: 10px;
      }

      .feedback-form {
        padding: 20px 15px;
      }

      .form-group input,
      .form-group textarea {
        padding: 10px 12px 10px 40px;
        font-size: 0.95rem;
      }

      .form-group i {
        left: 12px;
        font-size: 1rem;
      }
    }
    
    /* Safe area insets for notch phones */
    @supports (padding: max(0px)) {
      .top-left-group, .top-right {
        top: max(20px, env(safe-area-inset-top));
      }
      
      .bottom-center-group {
        bottom: max(25px, env(safe-area-inset-bottom));
      }
    }
  </style>
</head>
<body>

  <!-- Loading Screen -->
  <div id="loading" class="loading">
    <h3>🚀 Loading AR Museum</h3>
    <p id="loadMessage">Initializing camera...</p>
    <div id="loadProgress">0%</div>
    <div id="errorContainer"></div>
    <button id="retryCameraBtn" class="camera-permission-btn" style="display: none;">Retry Camera Access</button>
  </div>

  <!-- Recording Indicator -->
  <div class="recording-indicator" id="recordingIndicator">
    <div class="dot"></div>
    <span>Recording...</span>
  </div>

  <!-- Hidden video element for camera access -->
  <video id="cameraVideo" autoplay muted playsinline></video>

  <!-- UI Controls -->
  <div class="top-left-group">
    <button id="mapBtn" class="icon-btn"><i class="fa-solid fa-map"></i></button>
  </div>

  <select id="languageSwitcher" class="top-right">
    <option value="en">EN</option>
    <option value="ph">PH</option>
    <option value="zh">中文</option>
    <option value="jp">日本語</option>
  </select>

  <div class="bottom-center-group">
    <button id="cameraBtn" class="icon-btn"><i class="fas fa-camera"></i></button>
    <button id="videoBtn" class="icon-btn"><i class="fas fa-video"></i></button>
  </div>

  <!-- Feedback Button -->
  <button class="feedback-btn" onclick="openFeedback()">
    <i class="fas fa-comment-dots"></i>
  </button>

  <!-- Info Panel -->
  <div id="infoPanel" class="info-panel">
    <h3 id="infoTitle"></h3>
    <p id="infoDescription"></p>
    <button class="close-btn" onclick="closeInfoPanel()">Close</button>
  </div>

  <!-- Feedback Popup -->
  <div class="feedback-popup" id="feedbackPopup">
    <div class="feedback-form">
      <button class="close-feedback" onclick="closeFeedback()">
        <i class="fas fa-times"></i>
      </button>
      
      <div class="feedback-header">
        <h2><i class="fas fa-comment-dots"></i> Send Feedback</h2>
        <p>We'd love to hear about your AR Museum experience!</p>
      </div>

      <form id="feedbackForm">
        <div class="form-group">
          <i class="fas fa-user"></i>
          <input type="text" id="name" name="name" placeholder="Your Name" required>
        </div>

        <div class="form-group">
          <i class="fas fa-envelope"></i>
          <input type="email" id="email" name="email" placeholder="Your Email" required>
        </div>

        <div class="form-group">
          <i class="fas fa-star"></i>
          <select id="rating" name="rating" class="form-control" style="padding-left: 45px;" required>
            <option value="">Select Rating</option>
            <option value="5">★★★★★ Excellent</option>
            <option value="4">★★★★☆ Very Good</option>
            <option value="3">★★★☆☆ Good</option>
            <option value="2">★★☆☆☆ Fair</option>
            <option value="1">★☆☆☆☆ Poor</option>
          </select>
        </div>

        <div class="form-group textarea">
          <i class="fas fa-comment"></i>
          <textarea id="comment" name="comment" placeholder="Your feedback or suggestions..." required></textarea>
        </div>

        <button type="submit" class="submit-btn">
          <i class="fas fa-paper-plane"></i> Submit Feedback
        </button>
      </form>

      <div class="success-message" id="successMessage">
        <i class="fas fa-check-circle"></i>
        <h3>Thank You!</h3>
        <p>Your feedback has been submitted successfully.</p>
      </div>
    </div>
  </div>

  <!-- AR Scene - MOBILE OPTIMIZED -->
  <a-scene 
    embedded 
    arjs="sourceType: webcam; 
          debugUIEnabled: false; 
          detectionMode: mono_and_matrix; 
          matrixCodeType: 3x3; 
          maxDetectionRate: 30;
          facingMode: environment;"
    vr-mode-ui="enabled: false"
    renderer="colorManagement: true; precision: medium;"
    gesture-detector
    device-orientation-permission-ui="enabled: false"
  >
    <a-assets>
      <!-- Preload optimized models for mobile -->
      <a-asset-item id="ancientSculpture" src="models/sculpture.glb"></a-asset-item>
      <a-asset-item id="historicalPainting" src="models/painting.glb"></a-asset-item>
      <a-asset-item id="artifactsExhibit" src="models/artifact.glb"></a-asset-item>
    </a-assets>

    <!-- Mobile-optimized camera -->
    <a-entity camera="fov: 60; near: 0.01; far: 1000;" look-controls="touchEnabled: true"></a-entity>
    
    <!-- Marker-based AR content -->
  </a-scene>

  <script>
    // FEEDBACK FUNCTIONS
    function openFeedback() {
      document.getElementById("feedbackPopup").classList.add("active");
      // Clear form when opening
      document.getElementById('feedbackForm').reset();
      document.getElementById('successMessage').style.display = 'none';
      document.getElementById('feedbackForm').style.display = 'block';
    }

    function closeFeedback() {
      document.getElementById("feedbackPopup").classList.remove("active");
    }

    async function submitFeedback(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const feedbackData = {
        name: formData.get('name'),
        email: formData.get('email'),
        rating: parseInt(formData.get('rating')),
        comment: formData.get('comment')
      };

      // Validation
      if (!feedbackData.name || !feedbackData.email || !feedbackData.rating || !feedbackData.comment) {
        alert('Please fill in all fields');
        return;
      }

      try {
        const response = await fetch('save_feedback.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(feedbackData)
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Show success message
          document.getElementById('successMessage').style.display = 'block';
          document.getElementById('feedbackForm').style.display = 'none';
          
          // Auto close after 3 seconds
          setTimeout(() => {
            closeFeedback();
            document.getElementById('feedbackForm').style.display = 'block';
          }, 3000);
        } else {
          alert('Error: ' + data.message);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Network error. Please check your connection and try again.');
      }
    }

    // Update the event listener for the form
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('feedbackForm').addEventListener('submit', submitFeedback);
    });

    // Close feedback popup when clicking outside
    document.getElementById('feedbackPopup').addEventListener('click', function(e) {
      if (e.target === this) {
        closeFeedback();
      }
    });

    // Close with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeFeedback();
      }
    });

    // MOBILE-OPTIMIZED AR SYSTEM
    class MobileARMuseum {
      constructor() {
        this.currentLanguage = 'en';
        this.arContent = [];
        this.loadedMarkers = new Set();
        this.isMobile = this.detectMobile();
        this.deviceTier = this.detectDeviceTier();
        this.cameraStream = null;
        this.cameraInitialized = false;
        
        // Video recording variables
        this.isRecording = false;
        this.mediaRecorder = null;
        this.recordedChunks = [];
        this.videoElement = document.getElementById('cameraVideo');
        this.recordingTimer = null;
        this.recordingStartTime = null;
        
        // Touch event variables for video button
        this.videoButtonPressed = false;
        this.videoButtonTimer = null;

        // Canvas for combining video and AR
        this.canvas = document.createElement('canvas');
        this.ctx = this.canvas.getContext('2d');
        this.canvas.style.display = 'none';
        document.body.appendChild(this.canvas);
      }
      
      detectMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      }
      
      detectDeviceTier() {
        if (/iPhone|iPad|Samsung|Google Pixel/i.test(navigator.userAgent)) {
          return 'high';
        } else if (/Android/i.test(navigator.userAgent)) {
          return 'medium';
        } else {
          return 'low';
        }
      }

      isWebARSupported() {
        const requiredAPIs = [
          'mediaDevices' in navigator,
          'getUserMedia' in (navigator.mediaDevices || {}),
          'BarcodeDetector' in window || true
        ];
        
        return requiredAPIs.every(api => api === true);
      }

      showWebARNotSupported() {
        const errorContainer = document.getElementById('errorContainer');
        errorContainer.innerHTML = `
          <div class="error-message">
            <strong>⚠️ AR Not Supported</strong><br><br>
            Ang iyong browser/device ay hindi fully supported ang AR features.<br><br>
            Subukan ang:<br>
            • Chrome (Android)<br>
            • Safari (iOS)<br><br>
            Siguraduhing HTTPS ang gamit.
          </div>
        `;
      }

      showInitializationError(error) {
        const errorContainer = document.getElementById('errorContainer');
        errorContainer.innerHTML = `
          <div class="error-message">
            <strong>❌ AR Initialization Failed</strong><br><br>
            Error: ${error.message}<br><br>
            Pakisubukan muli o i-restart ang browser.
          </div>
        `;
        document.getElementById('retryCameraBtn').style.display = 'block';
      }
      
      async init() {
        try {
          // Check kung supported ng browser
          if (!this.isWebARSupported()) {
            this.showWebARNotSupported();
            this.updateLoading('Browser not supported', 100);
            return;
          }
          
          // Show mobile-specific instructions
          if (this.isMobile) {
            this.updateLoading('Itutok ang camera sa marker images...', 10);
          }

          // Initialize camera first
          this.updateLoading('Accessing camera...', 30);
          const cameraSuccess = await this.initializeARCamera();
          
          if (!cameraSuccess) {
            throw new Error('Hindi ma-access ang camera');
          }
          
          this.cameraInitialized = true;
          this.updateLoading('Camera ready! Loading content...', 50);
          
          await this.loadARContent();
          this.setupEventListeners();
          
          this.updateLoading('Ready! Point camera at markers', 100);
          this.hideLoading();
        } catch (error) {
          console.error('AR initialization failed:', error);
          this.showInitializationError(error);
        }
      }

      async initializeARCamera() {
        try {
          // Get camera stream directly
          this.cameraStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
              facingMode: 'environment',
              width: { ideal: 1920 },
              height: { ideal: 1080 }
            },
            audio: true // Include audio for video recording
          });
          
          // Set up the video element
          this.videoElement.srcObject = this.cameraStream;
          this.videoElement.play();
          
          // Wait for video to be ready
          await new Promise((resolve) => {
            this.videoElement.onloadedmetadata = () => {
              // Set canvas size to match video
              this.canvas.width = this.videoElement.videoWidth;
              this.canvas.height = this.videoElement.videoHeight;
              resolve();
            };
          });
          
          console.log('Camera initialized successfully');
          return true;
          
        } catch (error) {
          console.error('Camera initialization failed:', error);
          return false;
        }
      }
      
      async loadARContent() {
        this.updateLoading('Loading AR Content...', 60);
        
        try {
          const apiUrl = 'http://localhost/MUSEUM_SYSTEM/api/get_content.php';
          console.log('Fetching content from:', apiUrl);
          
          const response = await fetch(apiUrl);
          
          if (response.ok) {
            this.arContent = await response.json();
            console.log('Loaded content from API:', this.arContent);
            this.updateLoading('Creating AR Markers...', 80);
            this.createARMarkers();
            this.updateLoading('Ready! Point camera at markers', 100);
          } else {
            throw new Error('Failed to fetch content from API');
          }
        } catch (error) {
          console.error('Error loading AR content:', error);
          // Fallback to sample content
          this.updateLoading('Using sample content', 70);
          this.arContent = this.getSampleContent();
          this.createARMarkers();
          this.updateLoading('Ready! Point camera at markers', 100);
        }
      }

      getSampleContent() {
        return [
          {
            id: 1,
            title_en: "Ancient Sculpture",
            title_ph: "Sinaunang Iskultura",
            title_zh: "古代雕塑",
            title_jp: "古代彫刻",
            description_en: "A beautiful ancient sculpture from historical times.",
            description_ph: "Isang magandang sinaunang iskultura mula sa makasaysayang panahon.",
            marker_pattern: "https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png",
            category: "historical",
            model_file: ""
          },
          {
            id: 2,
            title_en: "Historical Painting",
            title_ph: "Makasaysayang Pintura",
            title_zh: "历史绘画",
            title_jp: "歴史的絵画",
            description_en: "A masterpiece painting from the renaissance period.",
            description_ph: "Isang obra maestrang pintura mula sa panahon ng renaissance.",
            marker_pattern: "https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/kanji.png",
            category: "art",
            model_file: ""
          }
        ];
      }
      
      createARMarkers() {
        const scene = document.querySelector('a-scene');
        
        // Clear existing markers first
        const existingMarkers = scene.querySelectorAll('a-marker');
        existingMarkers.forEach(marker => marker.remove());
        
        this.arContent.forEach(content => {
          const marker = document.createElement('a-marker');
          marker.setAttribute('type', 'pattern');
          marker.setAttribute('url', content.marker_pattern);
          marker.setAttribute('id', `marker-${content.id}`);
          marker.setAttribute('emitevents', 'true');
          marker.setAttribute('size', '0.5');
          marker.setAttribute('smooth', 'true');
          marker.setAttribute('smoothCount', '5');
          marker.setAttribute('smoothTolerance', '0.01');
          marker.setAttribute('smoothThreshold', '2');
          
          // Touch events for mobile
          marker.setAttribute('cursor', 'rayOrigin: mouse');
          marker.classList.add('clickable');
          
          // 3D Model - MOBILE OPTIMIZED
          if (content.model_file && content.model_file.trim() !== '') {
            const model = document.createElement('a-entity');
            
            if (content.model_file.toLowerCase().endsWith('.glb') || 
                content.model_file.toLowerCase().endsWith('.gltf')) {
              model.setAttribute('gltf-model', `url(${content.model_file})`);
            }
            
            // Mobile-optimized scaling
            const scale = this.getMobileScale(content.category);
            model.setAttribute('scale', scale);
            model.setAttribute('position', '0 0.3 0');
            model.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 25000');
            
            // Performance optimizations
            model.setAttribute('shadow', 'cast: false; receive: false');
            
            marker.appendChild(model);
          } else {
            // Fallback model
            const scale = this.getMobileScale(content.category);
            this.addFallbackModel(marker, content.category, scale);
          }
          
          // Title - MOBILE OPTIMIZED
          const text = document.createElement('a-text');
          text.setAttribute('value', content.title_en || content.title);
          text.setAttribute('position', '0 1.2 0');
          text.setAttribute('align', 'center');
          text.setAttribute('color', '#00ff66');
          text.setAttribute('scale', this.isMobile ? '2 2 2' : '3 3 3');
          text.setAttribute('width', '4');
          marker.appendChild(text);
          
          // Info button - MOBILE FRIENDLY
          const infoBtn = document.createElement('a-entity');
          infoBtn.setAttribute('geometry', 'primitive: circle; radius: 0.3');
          infoBtn.setAttribute('material', 'color: #00ff66; opacity: 0.9');
          infoBtn.setAttribute('position', '0 1.8 0');
          infoBtn.setAttribute('text', `value: ℹ️; align: center; width: 2; color: black`);
          infoBtn.setAttribute('class', 'clickable');
          infoBtn.setAttribute('animation', 'property: scale; to: 1.1 1.1 1.1; dir: alternate; dur: 1500; loop: true');
          
          // Touch events
          infoBtn.addEventListener('click', () => {
            this.showInfoPanel(content);
          });
          
          marker.appendChild(infoBtn);
          
          // Marker found event
          marker.addEventListener('markerFound', () => {
            console.log('Marker found:', content.title_en || content.title);
          });

          marker.addEventListener('markerLost', () => {
            console.log('Marker lost:', content.title_en || content.title);
          });
          
          scene.appendChild(marker);
        });
      }
      
      getMobileScale(category) {
        const scaleMap = {
          'historical': '1 1 1',
          'scientific': '0.8 0.8 0.8', 
          'art': '1.2 1.2 1.2',
          'interactive': '0.7 0.7 0.7',
          'default': '1 1 1'
        };
        return scaleMap[category] || scaleMap['default'];
      }
      
      addFallbackModel(marker, category, scale) {
        const modelMap = {
          'historical': 'ancientSculpture',
          'scientific': 'artifactsExhibit',
          'art': 'historicalPainting',
          'interactive': 'artifactsExhibit',
          'default': 'ancientSculpture'
        };
        
        const modelId = modelMap[category] || modelMap['default'];
        const model = document.createElement('a-entity');
        model.setAttribute('gltf-model', `#${modelId}`);
        model.setAttribute('scale', scale);
        model.setAttribute('position', '0 0.3 0');
        model.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 25000');
        model.setAttribute('shadow', 'cast: false; receive: false');
        marker.appendChild(model);
      }
      
      showInfoPanel(content) {
        const title = content.title_en || content.title || 'No Title';
        const description = content.description_en || content.description || 'No description available.';
        
        document.getElementById('infoTitle').textContent = title;
        document.getElementById('infoDescription').textContent = description;
        document.getElementById('infoPanel').style.display = 'block';
      }
      
      updateLoading(message, percent) {
        document.getElementById('loadMessage').textContent = message;
        document.getElementById('loadProgress').textContent = percent + '%';
      }
      
      hideLoading() {
        setTimeout(() => {
          document.getElementById('loading').style.display = 'none';
        }, 1000);
      }
      
      setupEventListeners() {
        // Language switcher
        document.getElementById('languageSwitcher').addEventListener('change', (e) => {
          this.currentLanguage = e.target.value;
          this.updateTexts();
        });
        
        // Camera capture
        document.getElementById('cameraBtn').addEventListener('click', () => {
          this.capturePhoto();
        });
        
        // Video recording - TOUCH EVENTS for hold to record
        const videoBtn = document.getElementById('videoBtn');
        
        // Touch start - start recording after 0.5 seconds
        videoBtn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          this.videoButtonPressed = true;
          
          this.videoButtonTimer = setTimeout(() => {
            if (this.videoButtonPressed) {
              this.startVideoRecording();
            }
          }, 500);
        });
        
        // Touch end - stop recording
        videoBtn.addEventListener('touchend', (e) => {
          e.preventDefault();
          this.videoButtonPressed = false;
          clearTimeout(this.videoButtonTimer);
          
          if (this.isRecording) {
            this.stopVideoRecording();
          }
        });
        
        // Mouse events for desktop testing
        videoBtn.addEventListener('mousedown', (e) => {
          e.preventDefault();
          this.videoButtonPressed = true;
          
          this.videoButtonTimer = setTimeout(() => {
            if (this.videoButtonPressed) {
              this.startVideoRecording();
            }
          }, 500);
        });
        
        videoBtn.addEventListener('mouseup', (e) => {
          e.preventDefault();
          this.videoButtonPressed = false;
          clearTimeout(this.videoButtonTimer);
          
          if (this.isRecording) {
            this.stopVideoRecording();
          }
        });
        
        // Prevent context menu on long press
        videoBtn.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          return false;
        });

        // Retry camera button
        document.getElementById('retryCameraBtn').addEventListener('click', () => {
          this.retryCameraAccess();
        });
        
        // Touch event improvements
        this.improveTouchEvents();
      }

      async retryCameraAccess() {
        document.getElementById('errorContainer').innerHTML = '';
        document.getElementById('retryCameraBtn').style.display = 'none';
        this.updateLoading('Retrying camera access...', 10);
        
        try {
          const cameraSuccess = await this.initializeARCamera();
          if (cameraSuccess) {
            this.cameraInitialized = true;
            this.updateLoading('Camera access successful! Loading content...', 50);
            await this.loadARContent();
            this.setupEventListeners();
            this.updateLoading('Ready!', 100);
            this.hideLoading();
          } else {
            throw new Error('Camera access still failed');
          }
        } catch (error) {
          this.showInitializationError(error);
        }
      }
      
      improveTouchEvents() {
        // Prevent zoom on double-tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
          const now = (new Date()).getTime();
          if (now - lastTouchEnd <= 300) {
            event.preventDefault();
          }
          lastTouchEnd = now;
        }, false);
        
        // Prevent pull-to-refresh
        document.addEventListener('touchmove', function (event) {
          if (event.scale !== 1) { event.preventDefault(); }
        }, false);
      }
      
      updateTexts() {
        document.querySelectorAll('a-marker').forEach(marker => {
          const text = marker.querySelector('a-text');
          const contentId = marker.id.replace('marker-', '');
          const content = this.arContent.find(c => c.id == contentId);
          
          if (content && text) {
            text.setAttribute('value', content[`title_${this.currentLanguage}`] || content.title_en || content.title);
          }
        });
      }
      
      capturePhoto() {
        try {
          // Draw current frame from camera video combined with AR scene
          this.combineCameraAndAR();
          
          // Convert canvas to blob
          this.canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            
            // Mobile-friendly download
            if (this.isMobile) {
              const link = document.createElement('a');
              link.href = url;
              link.download = 'armuseum_photo.jpg';
              
              if (navigator.share) {
                const file = new File([blob], 'armuseum_photo.jpg', { type: 'image/jpeg' });
                navigator.share({
                  files: [file],
                  title: 'AR Museum Photo',
                  text: 'Check out my AR Museum photo!'
                }).catch(() => {
                  link.click();
                });
              } else {
                link.click();
              }
            } else {
              const link = document.createElement('a');
              link.href = url;
              link.download = 'armuseum_photo.jpg';
              link.click();
            }
            
            URL.revokeObjectURL(url);
            
            // Show confirmation
            this.showTemporaryMessage('📸 Photo saved!');
          }, 'image/jpeg', 0.9);
        } catch (error) {
          console.error('Photo capture failed:', error);
          this.showTemporaryMessage('❌ Photo capture failed');
        }
      }
      
      combineCameraAndAR() {
        // Clear canvas
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        // Draw camera video
        this.ctx.drawImage(this.videoElement, 0, 0, this.canvas.width, this.canvas.height);
        
        // Get AR scene canvas
        const scene = document.querySelector('a-scene');
        const arCanvas = scene.canvas;
        
        // Draw AR overlay on top of camera video
        this.ctx.drawImage(arCanvas, 0, 0, this.canvas.width, this.canvas.height);
      }
      
      async startVideoRecording() {
        try {
          if (this.isRecording) return;
          
          // Create a new canvas for recording
          const recordCanvas = document.createElement('canvas');
          recordCanvas.width = this.videoElement.videoWidth;
          recordCanvas.height = this.videoElement.videoHeight;
          const recordCtx = recordCanvas.getContext('2d');
          
          // Create stream from canvas
          const stream = recordCanvas.captureStream(30);
          
          // Add audio track if available
          if (this.cameraStream.getAudioTracks().length > 0) {
            stream.addTrack(this.cameraStream.getAudioTracks()[0]);
          }
          
          // Create media recorder
          this.mediaRecorder = new MediaRecorder(stream, {
            mimeType: 'video/webm;codecs=vp9,opus',
            videoBitsPerSecond: 5000000 // 5 Mbps for better quality
          });
          
          this.recordedChunks = [];
          
          this.mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
              this.recordedChunks.push(event.data);
            }
          };
          
          this.mediaRecorder.onstop = () => {
            this.saveRecordedVideo();
          };
          
          // Start recording
          this.mediaRecorder.start(100);
          this.isRecording = true;
          
          // Update UI
          document.getElementById('videoBtn').classList.add('recording');
          document.getElementById('recordingIndicator').style.display = 'flex';
          
          // Start timer
          this.recordingStartTime = Date.now();
          this.updateRecordingTimer();
          
          // Recording loop - combine camera and AR frames
          const recordFrame = () => {
            if (!this.isRecording) return;
            
            // Combine camera video with AR overlay
            recordCtx.clearRect(0, 0, recordCanvas.width, recordCanvas.height);
            recordCtx.drawImage(this.videoElement, 0, 0, recordCanvas.width, recordCanvas.height);
            
            const scene = document.querySelector('a-scene');
            const arCanvas = scene.canvas;
            recordCtx.drawImage(arCanvas, 0, 0, recordCanvas.width, recordCanvas.height);
            
            requestAnimationFrame(recordFrame);
          };
          
          recordFrame();
          
          console.log('Video recording started');
          
        } catch (error) {
          console.error('Error starting video recording:', error);
          this.showTemporaryMessage('❌ Failed to start recording');
        }
      }
      
      stopVideoRecording() {
        if (!this.isRecording || !this.mediaRecorder) return;
        
        this.mediaRecorder.stop();
        this.isRecording = false;
        
        // Clear timer
        clearTimeout(this.recordingTimer);
        
        // Update UI
        document.getElementById('videoBtn').classList.remove('recording');
        document.getElementById('recordingIndicator').style.display = 'none';
        
        console.log('Video recording stopped');
      }
      
      updateRecordingTimer() {
        if (!this.isRecording) return;
        
        const elapsed = Date.now() - this.recordingStartTime;
        const seconds = Math.floor(elapsed / 1000);
        document.getElementById('recordingIndicator').innerHTML = `
          <div class="dot"></div>
          <span>Recording... ${seconds}s</span>
        `;
        
        this.recordingTimer = setTimeout(() => this.updateRecordingTimer(), 1000);
      }
      
      saveRecordedVideo() {
        const blob = new Blob(this.recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        
        // Create download link
        const a = document.createElement('a');
        a.href = url;
        a.download = `armuseum_video_${new Date().getTime()}.webm`;
        
        // Auto-download
        a.click();
        
        // Clean up
        URL.revokeObjectURL(url);
        this.recordedChunks = [];
        
        // Show confirmation
        this.showTemporaryMessage('🎥 Video saved!');
      }
      
      showTemporaryMessage(message) {
        // Create temporary message element
        const msgEl = document.createElement('div');
        msgEl.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0,0,0,0.8);
          color: white;
          padding: 15px 25px;
          border-radius: 10px;
          z-index: 10000;
          font-size: 16px;
          font-weight: bold;
          backdrop-filter: blur(10px);
          border: 2px solid #00ff66;
        `;
        msgEl.textContent = message;
        document.body.appendChild(msgEl);
        
        // Remove after 2 seconds
        setTimeout(() => {
          document.body.removeChild(msgEl);
        }, 2000);
      }

      // Cleanup method
      destroy() {
        if (this.cameraStream) {
          this.cameraStream.getTracks().forEach(track => track.stop());
        }
        
        if (this.isRecording) {
          this.stopVideoRecording();
        }
        
        clearTimeout(this.videoButtonTimer);
        clearTimeout(this.recordingTimer);
      }
    }
    
    function closeInfoPanel() {
      document.getElementById('infoPanel').style.display = 'none';
    }

    // Global museum instance
    let museum;

    // Mobile initialization
    window.addEventListener('DOMContentLoaded', async () => {
      museum = new MobileARMuseum();
      await museum.init();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (museum) {
        museum.destroy();
      }
    });
    
    // Prevent accidental zoom
    document.addEventListener('gesturestart', function (e) {
      e.preventDefault();
    });
    
    document.addEventListener('gesturechange', function (e) {
      e.preventDefault();
    });

    // Handle visibility change (tab switching)
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        console.log('Page hidden - pausing AR');
      } else {
        console.log('Page visible - resuming AR');
      }
    });
  </script>
</body>
</html>
