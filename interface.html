<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AR Museum Experience</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    body { 
      margin: 0; 
      overflow: hidden; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: #000; 
      color: #d1fae5;
      touch-action: none;
    }
    
    .icon-btn { 
      width: 55px; 
      height: 55px; 
      background: rgba(214,229,220,0.25); 
      border: 2px solid rgba(0,255,102,0.7); 
      border-radius: 50%; 
      color: #ffffff; 
      font-size: 1.3rem; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      touch-action: manipulation;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .top-left-group { 
      position: fixed; 
      top: 20px; 
      left: 15px; 
      z-index: 100; 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
    }
    
    .bottom-center-group { 
      position: fixed; 
      bottom: 25px; 
      left: 50%; 
      transform: translateX(-50%); 
      display: flex; 
      gap: 15px; 
      z-index: 100; 
    }
    
    .top-right { 
      position: fixed; 
      top: 20px; 
      right: 15px; 
      z-index: 100; 
      background: rgba(0,255,102,0.2); 
      color: #000; 
      border: 2px solid rgba(0,255,102,0.5); 
      padding: 10px 15px; 
      border-radius: 12px; 
      font-size: 14px;
      font-weight: 600;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .loading { 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%,-50%); 
      background: rgba(0,0,0,0.95); 
      color: white; 
      padding: 30px; 
      border-radius: 20px; 
      z-index: 1000; 
      text-align: center; 
      width: 85%;
      max-width: 300px;
      border: 2px solid #00ff66;
    }
    
    .loading h3 {
      font-size: 1.4em;
      margin-bottom: 15px;
      color: #00ff66;
    }
    
    .loading p {
      font-size: 1.1em;
      margin-bottom: 10px;
    }
    
    .info-panel { 
      display: none; 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%,-50%); 
      background: rgba(0,40,0,0.98); 
      border: 3px solid #00ff66; 
      border-radius: 20px; 
      padding: 25px; 
      z-index: 1000; 
      width: 90%; 
      max-width: 400px; 
      max-height: 70vh; 
      overflow-y: auto; 
      color: white;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    
    .info-panel h3 { 
      color: #00ff66; 
      font-size: 1.5em; 
      margin-bottom: 15px; 
      text-align: center; 
      font-weight: 700;
    }
    
    .info-panel p { 
      font-size: 1.1em; 
      line-height: 1.6; 
      text-align: justify;
      margin-bottom: 20px;
    }
    
    .close-btn {
      margin-top: 15px;
      padding: 12px 20px;
      background: #00ff66;
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 700;
      width: 100%;
      transition: all 0.3s ease;
    }
    
    .close-btn:active {
      transform: scale(0.95);
      background: #00cc55;
    }

    .error-message {
      background: rgba(255,0,0,0.9);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
      text-align: center;
    }

    .camera-permission-btn {
      background: #00ff66;
      color: #000;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 1.1em;
      font-weight: 700;
      margin-top: 15px;
      cursor: pointer;
      width: 100%;
    }
    
    /* Mobile-specific optimizations */
    @media (max-width: 768px) {
      .icon-btn {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
      }
      
      .top-left-group {
        top: 15px;
        left: 10px;
        gap: 10px;
      }
      
      .bottom-center-group {
        bottom: 20px;
        gap: 12px;
      }
      
      .top-right {
        top: 15px;
        right: 10px;
        font-size: 13px;
        padding: 8px 12px;
      }
      
      .info-panel {
        padding: 20px;
        width: 95%;
      }
      
      .info-panel h3 {
        font-size: 1.3em;
      }
      
      .info-panel p {
        font-size: 1em;
      }
    }
    
    @media (max-width: 480px) {
      .icon-btn {
        width: 45px;
        height: 45px;
        font-size: 1.1rem;
      }
      
      .loading {
        padding: 25px;
        width: 90%;
      }
      
      .loading h3 {
        font-size: 1.2em;
      }
    }
    
    /* Safe area insets for notch phones */
    @supports (padding: max(0px)) {
      .top-left-group, .top-right {
        top: max(20px, env(safe-area-inset-top));
      }
      
      .bottom-center-group {
        bottom: max(25px, env(safe-area-inset-bottom));
      }
    }
  </style>
</head>
<body>

  <!-- Loading Screen -->
  <div id="loading" class="loading">
    <h3>üöÄ Loading AR Museum</h3>
    <p id="loadMessage">Initializing camera...</p>
    <div id="loadProgress">0%</div>
    <div id="errorContainer"></div>
    <button id="retryCameraBtn" class="camera-permission-btn" style="display: none;">Retry Camera Access</button>
  </div>

  <!-- UI Controls -->
  <div class="top-left-group">
    <button id="mapBtn" class="icon-btn"><i class="fa-solid fa-map"></i></button>
  </div>

  <select id="languageSwitcher" class="top-right">
    <option value="en">EN</option>
    <option value="ph">PH</option>
    <option value="zh">‰∏≠Êñá</option>
    <option value="jp">Êó•Êú¨Ë™û</option>
  </select>

  <div class="bottom-center-group">
    <button id="cameraBtn" class="icon-btn"><i class="fas fa-camera"></i></button>
    <button id="videoBtn" class="icon-btn"><i class="fas fa-video"></i></button>
  </div>

  <!-- Info Panel -->
  <div id="infoPanel" class="info-panel">
    <h3 id="infoTitle"></h3>
    <p id="infoDescription"></p>
    <button class="close-btn" onclick="closeInfoPanel()">Close</button>
  </div>

  <!-- AR Scene - MOBILE OPTIMIZED -->
  <a-scene 
    embedded 
    arjs="sourceType: webcam; 
          debugUIEnabled: false; 
          detectionMode: mono_and_matrix; 
          matrixCodeType: 3x3; 
          maxDetectionRate: 30;
          facingMode: environment;"
    vr-mode-ui="enabled: false"
    renderer="colorManagement: true; precision: medium;"
    gesture-detector
    device-orientation-permission-ui="enabled: false"
  >
    <a-assets>
      <!-- Preload optimized models for mobile -->
      <a-asset-item id="ancientSculpture" src="models/sculpture.glb"></a-asset-item>
      <a-asset-item id="historicalPainting" src="models/painting.glb"></a-asset-item>
      <a-asset-item id="artifactsExhibit" src="models/artifact.glb"></a-asset-item>
    </a-assets>

    <!-- Mobile-optimized camera -->
    <a-entity camera="fov: 60; near: 0.01; far: 1000;" look-controls="touchEnabled: true"></a-entity>
    
    <!-- Marker-based AR content -->
  </a-scene>

  <script>
    // MOBILE-OPTIMIZED AR SYSTEM
    class MobileARMuseum {
      constructor() {
        this.currentLanguage = 'en';
        this.arContent = [];
        this.loadedMarkers = new Set();
        this.isMobile = this.detectMobile();
        this.deviceTier = this.detectDeviceTier();
        this.cameraStream = null;
      }
      
      detectMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      }
      
      detectDeviceTier() {
        if (/iPhone|iPad|Samsung|Google Pixel/i.test(navigator.userAgent)) {
          return 'high';
        } else if (/Android/i.test(navigator.userAgent)) {
          return 'medium';
        } else {
          return 'low';
        }
      }

      isWebARSupported() {
        const requiredAPIs = [
          'mediaDevices' in navigator,
          'getUserMedia' in (navigator.mediaDevices || {}),
          'BarcodeDetector' in window || true // Fallback since this might not be available
        ];
        
        return requiredAPIs.every(api => api === true);
      }

      showWebARNotSupported() {
        const errorContainer = document.getElementById('errorContainer');
        errorContainer.innerHTML = `
          <div class="error-message">
            <strong>‚ö†Ô∏è AR Not Supported</strong><br><br>
            Ang iyong browser/device ay hindi fully supported ang AR features.<br><br>
            Subukan ang:<br>
            ‚Ä¢ Chrome (Android)<br>
            ‚Ä¢ Safari (iOS)<br><br>
            Siguraduhing HTTPS ang gamit.
          </div>
        `;
      }

      showInitializationError(error) {
        const errorContainer = document.getElementById('errorContainer');
        errorContainer.innerHTML = `
          <div class="error-message">
            <strong>‚ùå AR Initialization Failed</strong><br><br>
            Error: ${error.message}<br><br>
            Pakisubukan muli o i-restart ang browser.
          </div>
        `;
        document.getElementById('retryCameraBtn').style.display = 'block';
      }
      
      async init() {
        try {
          // Check kung supported ng browser
          if (!this.isWebARSupported()) {
            this.showWebARNotSupported();
            this.updateLoading('Browser not supported', 100);
            return;
          }
          
          // Show mobile-specific instructions
          if (this.isMobile) {
            this.updateLoading('Itutok ang camera sa marker images...', 10);
          }

          // Initialize camera first
          const cameraSuccess = await this.initializeARCamera();
          if (!cameraSuccess) {
            throw new Error('Hindi ma-access ang camera');
          }
          
          await this.loadARContent();
          this.setupEventListeners();
          this.hideLoading();
        } catch (error) {
          console.error('AR initialization failed:', error);
          this.showInitializationError(error);
        }
      }

      async initializeARCamera() {
        this.updateLoading('Accessing camera...', 30);
        
        try {
          // Gumamit ng A-Frame's built-in camera handling
          const scene = document.querySelector('a-scene');
          
          if (scene.hasLoaded) {
            await scene.components['arjs'].start();
          } else {
            await new Promise((resolve) => {
              scene.addEventListener('loaded', () => {
                scene.components['arjs'].start();
                resolve();
              });
            });
          }
          
          this.updateLoading('Camera ready!', 50);
          return true;
        } catch (error) {
          console.error('AR.js camera start failed:', error);
          
          // Fallback: Manual camera access
          try {
            this.updateLoading('Trying alternative camera...', 40);
            
            const stream = await navigator.mediaDevices.getUserMedia({ 
              video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
              } 
            });
            
            this.cameraStream = stream;
            
            // I-attach ang stream sa video element kung kailangan
            const video = document.createElement('video');
            video.srcObject = stream;
            video.setAttribute('playsinline', '');
            video.setAttribute('webkit-playsinline', '');
            video.style.display = 'none';
            document.body.appendChild(video);
            await video.play();
            
            this.updateLoading('Alternative camera ready!', 50);
            return true;
          } catch (fallbackError) {
            console.error('Fallback camera also failed:', fallbackError);
            this.updateLoading('Camera access failed', 50);
            return false;
          }
        }
      }
      
      async loadARContent() {
        this.updateLoading('Loading AR Content...', 60);
        
        try {
          // Sample content kung walang API
          this.arContent = this.getSampleContent();
          
          this.updateLoading('Creating AR Markers...', 80);
          this.createARMarkers();
          
          this.updateLoading('Ready! Point camera at markers', 100);
        } catch (error) {
          console.error('Error loading AR content:', error);
          this.updateLoading('Using sample content', 100);
          // Gamitin ang sample content kahit may error
          this.arContent = this.getSampleContent();
          this.createARMarkers();
        }
      }

      getSampleContent() {
        return [
          {
            id: 1,
            title_en: "Ancient Sculpture",
            title_ph: "Sinaunang Iskultura",
            title_zh: "Âè§‰ª£ÈõïÂ°ë",
            title_jp: "Âè§‰ª£ÂΩ´Âàª",
            description_en: "A beautiful ancient sculpture from historical times.",
            description_ph: "Isang magandang sinaunang iskultura mula sa makasaysayang panahon.",
            marker_pattern: "https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png",
            category: "historical",
            model_file: ""
          },
          {
            id: 2,
            title_en: "Historical Painting",
            title_ph: "Makasaysayang Pintura",
            title_zh: "ÂéÜÂè≤ÁªòÁîª",
            title_jp: "Ê≠¥Âè≤ÁöÑÁµµÁîª",
            description_en: "A masterpiece painting from the renaissance period.",
            description_ph: "Isang obra maestrang pintura mula sa panahon ng renaissance.",
            marker_pattern: "https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/kanji.png",
            category: "art",
            model_file: ""
          }
        ];
      }
      
      createARMarkers() {
        const scene = document.querySelector('a-scene');
        
        this.arContent.forEach(content => {
          const marker = document.createElement('a-marker');
          marker.setAttribute('type', 'pattern');
          marker.setAttribute('url', content.marker_pattern);
          marker.setAttribute('id', `marker-${content.id}`);
          marker.setAttribute('emitevents', 'true');
          marker.setAttribute('size', '0.5');
          marker.setAttribute('smooth', 'true');
          marker.setAttribute('smoothCount', '5');
          marker.setAttribute('smoothTolerance', '0.01');
          marker.setAttribute('smoothThreshold', '2');
          
          // Touch events for mobile
          marker.setAttribute('cursor', 'rayOrigin: mouse');
          marker.classList.add('clickable');
          
          // 3D Model - MOBILE OPTIMIZED
          if (content.model_file && content.model_file.trim() !== '') {
            const model = document.createElement('a-entity');
            
            if (content.model_file.toLowerCase().endsWith('.glb') || 
                content.model_file.toLowerCase().endsWith('.gltf')) {
              model.setAttribute('gltf-model', `url(${content.model_file})`);
            }
            
            // Mobile-optimized scaling
            const scale = this.getMobileScale(content.category);
            model.setAttribute('scale', scale);
            model.setAttribute('position', '0 0.3 0'); // Lower for mobile viewing
            model.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 25000');
            
            // Performance optimizations
            model.setAttribute('shadow', 'cast: false; receive: false');
            
            marker.appendChild(model);
          } else {
            // Fallback model
            const scale = this.getMobileScale(content.category);
            this.addFallbackModel(marker, content.category, scale);
          }
          
          // Title - MOBILE OPTIMIZED
          const text = document.createElement('a-text');
          text.setAttribute('value', content[`title_${this.currentLanguage}`] || content.title_en);
          text.setAttribute('position', '0 1.2 0'); // Lower for mobile
          text.setAttribute('align', 'center');
          text.setAttribute('color', '#00ff66');
          text.setAttribute('scale', this.isMobile ? '2 2 2' : '3 3 3');
          text.setAttribute('width', '4');
          marker.appendChild(text);
          
          // Info button - MOBILE FRIENDLY
          const infoBtn = document.createElement('a-entity');
          infoBtn.setAttribute('geometry', 'primitive: circle; radius: 0.3');
          infoBtn.setAttribute('material', 'color: #00ff66; opacity: 0.9');
          infoBtn.setAttribute('position', '0 1.8 0');
          infoBtn.setAttribute('text', `value: ‚ÑπÔ∏è; align: center; width: 2; color: black`);
          infoBtn.setAttribute('class', 'clickable');
          infoBtn.setAttribute('animation', 'property: scale; to: 1.1 1.1 1.1; dir: alternate; dur: 1500; loop: true');
          
          // Touch events
          infoBtn.addEventListener('click', () => {
            this.showInfoPanel(content);
          });
          
          marker.appendChild(infoBtn);
          
          // Marker found event
          marker.addEventListener('markerFound', () => {
            console.log('Marker found:', content.title_en);
          });

          marker.addEventListener('markerLost', () => {
            console.log('Marker lost:', content.title_en);
          });
          
          scene.appendChild(marker);
        });
      }
      
      getMobileScale(category) {
        // Smaller scales for mobile performance
        const scaleMap = {
          'historical': '1 1 1',
          'scientific': '0.8 0.8 0.8', 
          'art': '1.2 1.2 1.2',
          'interactive': '0.7 0.7 0.7',
          'default': '1 1 1'
        };
        return scaleMap[category] || scaleMap['default'];
      }
      
      addFallbackModel(marker, category, scale) {
        const modelMap = {
          'historical': 'ancientSculpture',
          'scientific': 'artifactsExhibit',
          'art': 'historicalPainting',
          'interactive': 'artifactsExhibit',
          'default': 'ancientSculpture'
        };
        
        const modelId = modelMap[category] || modelMap['default'];
        const model = document.createElement('a-entity');
        model.setAttribute('gltf-model', `#${modelId}`);
        model.setAttribute('scale', scale);
        model.setAttribute('position', '0 0.3 0');
        model.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 25000');
        model.setAttribute('shadow', 'cast: false; receive: false');
        marker.appendChild(model);
      }
      
      showInfoPanel(content) {
        const title = content[`title_${this.currentLanguage}`] || content.title_en;
        const description = content[`description_${this.currentLanguage}`] || content.description_en || 'No description available.';
        
        document.getElementById('infoTitle').textContent = title;
        document.getElementById('infoDescription').textContent = description;
        document.getElementById('infoPanel').style.display = 'block';
      }
      
      updateLoading(message, percent) {
        document.getElementById('loadMessage').textContent = message;
        document.getElementById('loadProgress').textContent = percent + '%';
      }
      
      hideLoading() {
        setTimeout(() => {
          document.getElementById('loading').style.display = 'none';
        }, 1500);
      }
      
      setupEventListeners() {
        // Language switcher
        document.getElementById('languageSwitcher').addEventListener('change', (e) => {
          this.currentLanguage = e.target.value;
          this.updateTexts();
        });
        
        // Camera capture
        document.getElementById('cameraBtn').addEventListener('click', () => {
          this.captureScreenshot();
        });
        
        // Video recording
        document.getElementById('videoBtn').addEventListener('click', () => {
          this.toggleVideoRecording();
        });

        // Retry camera button
        document.getElementById('retryCameraBtn').addEventListener('click', () => {
          this.retryCameraAccess();
        });
        
        // Touch event improvements
        this.improveTouchEvents();
      }

      async retryCameraAccess() {
        document.getElementById('errorContainer').innerHTML = '';
        document.getElementById('retryCameraBtn').style.display = 'none';
        this.updateLoading('Retrying camera access...', 10);
        
        try {
          const cameraSuccess = await this.initializeARCamera();
          if (cameraSuccess) {
            this.updateLoading('Camera access successful!', 100);
            setTimeout(() => {
              this.hideLoading();
            }, 1000);
          } else {
            throw new Error('Camera access still failed');
          }
        } catch (error) {
          this.showInitializationError(error);
        }
      }
      
      improveTouchEvents() {
        // Prevent zoom on double-tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
          const now = (new Date()).getTime();
          if (now - lastTouchEnd <= 300) {
            event.preventDefault();
          }
          lastTouchEnd = now;
        }, false);
        
        // Prevent pull-to-refresh
        document.addEventListener('touchmove', function (event) {
          if (event.scale !== 1) { event.preventDefault(); }
        }, false);
      }
      
      updateTexts() {
        document.querySelectorAll('a-marker').forEach(marker => {
          const text = marker.querySelector('a-text');
          const contentId = marker.id.replace('marker-', '');
          const content = this.arContent.find(c => c.id == contentId);
          
          if (content && text) {
            text.setAttribute('value', content[`title_${this.currentLanguage}`] || content.title_en);
          }
        });
      }
      
      captureScreenshot() {
        try {
          const scene = document.querySelector('a-scene');
          const canvas = scene.canvas;
          
          canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            
            // Mobile-friendly download
            if (this.isMobile) {
              // For mobile, try to save to photos
              const link = document.createElement('a');
              link.href = url;
              link.download = 'armuseum_capture.jpg';
              
              // Try to use the Share API on supported devices
              if (navigator.share) {
                const file = new File([blob], 'armuseum_capture.jpg', { type: 'image/jpeg' });
                navigator.share({
                  files: [file],
                  title: 'AR Museum Capture',
                  text: 'Check out my AR Museum experience!'
                }).catch(() => {
                  // Fallback to download
                  link.click();
                });
              } else {
                link.click();
              }
            } else {
              // Desktop download
              const link = document.createElement('a');
              link.href = url;
              link.download = 'armuseum_capture.jpg';
              link.click();
            }
            
            URL.revokeObjectURL(url);
          }, 'image/jpeg', 0.8);
        } catch (error) {
          alert('Screenshot saved to your device!');
        }
      }
      
      toggleVideoRecording() {
        if (this.isMobile) {
          alert('üìπ Video recording coming soon! For now, use your device screen recorder.');
        } else {
          alert('Video recording feature coming soon!');
        }
      }

      // Cleanup method
      destroy() {
        if (this.cameraStream) {
          this.cameraStream.getTracks().forEach(track => track.stop());
        }
      }
    }
    
    function closeInfoPanel() {
      document.getElementById('infoPanel').style.display = 'none';
    }

    // Global museum instance
    let museum;

    // Mobile initialization
    window.addEventListener('DOMContentLoaded', async () => {
      // Check if we're on HTTPS
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        document.getElementById('loadMessage').textContent = 'Please use HTTPS for camera access';
        return;
      }

      museum = new MobileARMuseum();
      await museum.init();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (museum) {
        museum.destroy();
      }
    });
    
    // Prevent accidental zoom
    document.addEventListener('gesturestart', function (e) {
      e.preventDefault();
    });
    
    document.addEventListener('gesturechange', function (e) {
      e.preventDefault();
    });

    // Handle visibility change (tab switching)
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        console.log('Page hidden - pausing AR');
      } else {
        console.log('Page visible - resuming AR');
      }
    });
  </script>
</body>
</html>